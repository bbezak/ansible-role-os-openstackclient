---
- name: Ensure EPEL repo is installed
  yum:
    name: epel-release
    state: installed
  become: True
  when:
    - os_openstackclient_install_epel | bool
    - ansible_distribution == "CentOS"

- name: Set fact containing debian specific packages
  set_fact:
    os_openstackclient_package_dependencies: "{{ os_openstackclient_package_dependencies_debian }}"
  when:
    - ansible_os_family == "Debian"

- name: Set fact containing redhat specific packages
  set_fact:
    os_openstackclient_package_dependencies: "{{ os_openstackclient_package_dependencies_redhat }}"
  when:
    - ansible_os_family == "RedHat"

- name: Ensure required packages are installed
  package:
    name: "{{ item }}"
    state: installed
  become: True
  with_items: "{{ os_openstackclient_package_dependencies }}"
  when: os_openstackclient_install_package_dependencies | bool

- name: Check whether the virtualenv directory exists
  stat:
    path: "{{ os_openstackclient_venv | dirname }}"
    get_md5: False
    get_checksum: False
    mime: False
  when: os_openstackclient_venv != None
  register: os_openstackclient_venv_stat

- name: Ensure the virtualenv directory exists
  file:
    path: "{{ os_openstackclient_venv | dirname }}"
    state: directory
    owner: "{{ ansible_user_uid }}"
    group: "{{ ansible_user_gid }}"
  become: True
  when:
    - os_openstackclient_venv != None
    - not os_openstackclient_venv_stat.stat.exists or
      not os_openstackclient_venv_stat.stat.writeable

- name: Ensure the latest version of pip is installed
  pip:
    name: "{{ item.name }}"
    state: latest
    virtualenv: "{{ os_openstackclient_venv or omit }}"
  with_items:
    - { name: pip }

- name: Ensure required Python packages are installed
  pip:
    name: "{{ item.name }}"
    version: "{{ item.version or omit }}"
    state: present
    virtualenv: "{{ os_openstackclient_venv or omit }}"
  with_items:
    - name: python-openstackclient
      version: "{{ os_openstackclient_version }}"
